# 生存分析(Survival Analysis)
生物の死亡や機械系の故障など、1つまたは複数の事象(イベント)が起こるまでの予想される**期間**を分析するための統計の一分野です。エンジニアリングでは信頼性分析(reliability analysis)、経済学では*duration analysis(期間分析)*、社会学ではイベント分析(event history analysis)と呼ばれる。

ex)

 - (労働経済学)「就職してから離職が発生するまでの時間」
 - (エンジニアリング)「部品が最初に使われてから正常に動作しなくなるまでの時間」
 - (社会学)「結婚してから離婚に至るまでの時間」
 - (医療)「ある疾患と診断されてから死亡するまでの時間」

## 参考文献

生存分析の文献

 - [Survival analysis - Wikipedia](https://en.wikipedia.org/wiki/Survival_analysis)
 - 汪　金芳〔2005〕「[生存時間解析入門](http://www.math.s.chiba-u.ac.jp/~wang/suvival.pdf)」
 - RUPERT G. MILLER, JR.〔1998〕*[SURVIVAL ANALYSIS ](https://leseprobe.buch.de/images-adb/52/46/52465573-7961-40d8-89a5-9aecddf9b529.pdf)*,スタンフォード大学;JOHN WILEY & SONS, INC.
 - 西川正子〔2008〕「[生存時間解析における競合リスクモデル](https://www.jstage.jst.go.jp/article/jjb/29/2/29_2_141/_pdf)」

セミパラメトリック/Cox比例ハザードモデル/加速モデル/加法ハザードモデルで参照

 - 服部 聡〔2009〕「[生存時間解析におけるセミパラメトリック推測とその周辺](http://www.ism.ac.jp/editsec/toukei/pdf/57-1-119.pdf)」

生存分析のための機械学習の論文

 - Blaz Zupan, Janez Demsar, Michael W. Kattan d, J. Robert Beck, I. Bratko〔2000〕”*[Machine learning for survival analysis: a case study on recurrence of prostate cancer](http://eprints.fri.uni-lj.si/890/1/1._B._Zupan%2C_J._Demsar%2C_M._W._Kattan%2C_J._R._Beck%2C_I._Bratko%2C_Artif_Intell_Med_20%2C_59-75_(2000)..pdf)*”

---
# 公式
## 生存関数
**ある時間$t$までに死亡する確率**は、累積確率分布関数で与えられる。
$$
F\left( t \right) =Pr\left( T<t \right) =\int _{ 0 }^{ t }{ f\left( u \right)du }
$$

 - 確率変数$T$: 生存時間
 - $f\left(t\right)$: 生存時間の確率密度関数

> **<font color="blue">生存関数</font>**(survivor function): ある時間$t$以上生存する確率
> $$
> S\left(t\right) = Pr\left( T \ge t \right) = 1 - F\left(t\right)
> $$
>
> 生存時間データの特徴<br>
> 1. 時間は非負値であり、一般的に値が大きい方向に長く裾を引く歪んだ分布となる<br>
> 2. 打切りが発生することも多い

## ハザード関数と累積ハザード関数
> **<font color="blue">ハザード関数</font>**(hazard function): 時間$t$までは生存しているという条件のもとで、$t$と$t+\delta t$の間に死亡する確率(の極限値)
> $$
> h\left(t\right) = - \frac {S^{\prime}\left(t\right)}{S\left(t\right)} = \frac {f\left(t\right)}{S\left(t\right)} \qquad (1)
> $$
>
> - 定義より、'(瞬間)死亡率'とも呼ばれる
> - '死亡率'は、特に人口統計学や数理科学で用いられるハザード関数の同義語である
>
> また、死亡率は以下のようにも定義される。
> $$
> h\left(t\right) = - \frac {d}{dt} \left\{ \log {\left[S\left(t\right)\right]} \right\} \qquad (2)
> $$
>

式(1)の証明:
ハザード関数は自身の定義より
$$
h\left( t \right) =\lim _{ \delta t\rightarrow 0 }{ \frac { Pr\left( { t \le T < t+\delta t }|{ T>t } \right)  }{ \delta t }  } \\ \qquad =\lim _{ \delta t\rightarrow 0 }{ \frac { F\left( t+\delta t \right) -F\left( t \right)  }{ \delta t }  } \times \frac { 1 }{ S\left( t \right)  }
$$
と定義される。ここで微分の公式により、
$$
\lim _{ \delta t\rightarrow 0 }{ \frac { F\left( t+\delta t \right) -F\left( t \right)  }{ \delta t }  } =F^{ \prime  }\left( t \right) =f\left( t \right)
$$
となるので、
$$
h\left(t\right) = \frac {f\left(t\right)}{S\left(t\right)}
$$
が成立する。

> **<font color="blue">累積ハザード関数</font>**(cumulative hazard function): ハザード関数の定義より、累積ハザード関数を定義できる。
>$$
>H\left(t\right) = \int _{0}^{t}{h\left(u\right)du}
>$$

累積ハザード関数は以下の関係式も得られる。
$$
S\left(t\right) = exp\left[ -H\left(t\right) \right]
$$
または、自然対数をとって、
$$
H\left(t\right) = - \log {\left[ S\left(t\right) \right]}
$$
とも表せる。

## 代表値

> **<font color="blue">中央生存時間</font>**(median survival time):
> ’平均的な’生存時間は通常、生存時間分布の中央値によって推定される。生存時間分布は裾野が長く歪んでいることが多いので、期待値よりも中央値の方が望ましいと考えられるからためである。
> 中央生存時間は、方程式
>$$
> F\left(t\right) = \frac {1}{2}
>$$
> の解として与えられる。

> **<font color="blue">パーセント点</font>**: $p$%点$t\left(p\right)$は、
> $$
> F\left[t\left(p\right)\right] = p/100
> $$
> または、
> $$
> S\left[t\left(p\right)\right] = 1 - p/100
> $$
> の解である

---
# 打切り(Censoring)
打切りは、生存分析でよく見られる欠落データ問題の一種です。

 - **打切り**(censored): もし観察対象が観察期間中にイベントの発生しなかった場合、**打切り**として記録される。
    - **右側打切り**(right censored): 観察対象が観察期間後に死亡・故障した場合、観測終了時($T_{c}$)で右側打切りされているという。
    - **左側打切り**(left censored): 観察対象が観察期間前にあるイベントが開始されている場合、観測開始時($T_{o}$)で左側打切りされているという。
    - **中間打切り**(interval censored): 観察対象が観察期間中の2つの時点で挟まれた時間のいずれかであることがわかるが、正確にいつであるのかはわからない。
 - **切捨て**(truncation): 生存期間がある閾値以下の被験者がまったく観察されないこともあります。これを**切捨て**という。
    - <font color="red">※</font>切捨ては左側打切りとは異なることに注意。なぜなら、左側打切りされたデータについては、観察対象者が存在することがわかっていますが、切捨てられたデータについては、観察対象者を完全に認識していない可能性があるため。

---
# パラメトリック法による推定・検定

> **<font color="blue">推定</font>**

> 生存関数の推定は、打切りによって複雑になる。打ち切りデータの存在下での生存関数の推定は、以下のように定式化される。(ここで各データの尤度は独立していると仮定されている)
>
> - *unc.*: 打切りじゃないデータ
> - *l.c.*: 左側打切りのデータ
> - *r.c.*: 右側打切りのデータ
> - *i.c.*: 中間打切りのデータ
>
>$$
>L\left(\theta\right) = \prod _{T_{i} \in unc.}{ Pr\left(T = T_{i} ; \theta\right) } \times \prod _{i \in l.c.}{ Pr\left(T < T_{i};\theta\right) } \times \prod _{i \in r.c.}{ Pr\left(T > T_{i};\theta\right) } \times \prod _{i \in i.c.}{ Pr\left(T_{i,l} < T < T_{i,r} ; \theta\right) }
>$$
> 打切りじゃない(uncensored)データでの確率関数は以下になる。
> $$
> Pr\left(T=T_{i}; \theta \right) = f\left(T_{i};\theta\right)
> $$
> 左側打切り(left-censored)のデータ: イベントが発生したのが時間$T_{i}$以下であることが既知
> $$
> Pr\left(T < T_{i}; \theta\right) = F\left(T_{i};\theta\right) = 1 - S\left( T_{i};\theta \right)
> $$
> 右側打切り(right-censored)のデータ: イベントが発生したのが時間$T_{i}$以上であることが既知
> $$
> Pr\left(T > T_{i}; \theta\right) = 1 - F\left( T_{i};\theta \right) = S\left( T_{i};\theta \right)
> $$
> 中間打切り(internal censored)のデータ: イベントが発生した時間が$T_{i,r}$以下、$T_{i,l}$以上であることが既知
> $$
> Pr\left(T_{i,l} < T < T_{i,r} ; \theta \right) = S\left( T_{i,l} ; \theta \right) - S\left( T_{i,r} ; \theta \right)
> $$


> **<font color="blue">モデルの評価</font>**


> **<font color="blue">検定</font>**

## 指数分布

## ワイブル分布

## 対数ロジスティック分布

## 正規分布


---
# ノンパラメトリック法による推定・検定

## カプラン・マイヤー推定(Kaplan-Meier estimete)
> Lifetimeデータから**生存関数**を推定するために使用されるノンパラメトリック統計量.
>
> - $d_{j}$: 時刻$t_{(j)}$でのイベント発生者数
> - $n_{j}$: 時刻$t_{(j)}$の直前で生存している被験者数
> - イベントが観測された時刻を小さい順に$t_{(1)} \le t_{(2)} \le \cdots \le t_{(k)}$とする
>
> $$
> \widehat {S}\left(t\right) = \prod _{ j=1 }^{ k }{ \left( \frac {n_{j} - d_{j}}{n_{j}} \right) }
> $$
>
> - サンプルサイズは十分に大きいとする
> - カプラン・マイヤー推定は、打切り(censored)データをも扱える方法である
> - $\widehat {S}\left(t\right)$の各時刻$t$ごとの分散は、近似的に次式で表現できる。$t$が$t_{(j)} < t \le t_{(j+1)}$であるとき、
> $$
> \widehat {Var}\left( \widehat {S}\left(t\right) \right) = {\widehat {S}}(t)^{2}\sum \limits _{t_{i} \le t}{\frac {d_{j}}{n_{j}(n_{j}-d_{j})}}
> $$

カプラン・マイヤー推定の考え:
カプラン・マイヤー推定法では、生存関数は次式から得られると仮定する。
$$
\widehat {S}\left(t\right) = \frac {生存時間がt以上となる被験者数}{総被験者数}
$$
そして、イベントが観測された時刻を小さい順に$t_{(1)} \le t_{(2)} \le \cdots \le t_{(k)}$と並べる。被験者が$t_{(j)}$の直前まで生存し、かつ$t_{(j)}$以降も生存する条件付確率は、
$$
\frac {(n_{j} - d_{j})}{n_{j}}
$$
である。各$t_{(j)}$は独立に生起していると仮定すれば、この条件付確率を次々に掛け合わせることで推定値が得られる。すなわち、$t_{(k)} \le t < t_{(k+1)}$における生存関数のカプラン・マイヤー推定値は次式になる。
$$
\widehat {S}\left(t\right) = \prod _{ j=1 }^{ k }{ \left( \frac {n_{j} - d_{j}}{n_{j}} \right) }
$$

## ネルソン・アーレン推定(Nelson-Aalen estimate)
> 不完全なデータや打切りデータの場合の**累積ハザード関数**を推定するための使用されるノンパラメトリック推定量。
>
> - $d_{i}$: 時刻$t_{i}$でのイベント発生者数
> - $n_{i}$: 時刻$T_{i}$の直前で生存している被験者数
>
> $$
> \widehat {H}\left(t\right) = \sum _{t_{i} \le t}{ \frac {d_{i}}{n_{i}} }
> $$


---
# その他分析手法
## あるグループのメンバーの生存時間の解析

 - Life tables
 - カプラン・マイヤー曲線の推定
 - 生存関数
 - ハザード関数

## ２つ以上のグループ間での生存時間の比較

 - ログ・ランク検定

## カテゴリーまたは量的変数が生存に及ぼす影響を説明する

 - Cox比例ハザード回帰(Cox proportional hazards regression)
 - パラメトリック生存モデル(Parametric survival models)
 - 生存ツリー(Survival trees)
 - 生存ランダムフォレスト(Survival random forests)
